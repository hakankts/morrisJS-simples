<?php
	require_once(dirname($_SERVER['DOCUMENT_ROOT']) . "/cgi-bin/functions.php");
	require_once(dirname($_SERVER['DOCUMENT_ROOT']) . "/root/yeni_ekran/dashboard_repostory/kullaniciKontrolClass.php");
	
	class chartClass extends kullaniciKontrolClass{

		protected $cdb;
		protected $hasarTable;					
		protected $companyId;			
		protected $kullaniciKriter;	
		protected $otodisiKullaniciKriter;
		protected $OTODISI_DOSYA_SORUMLUSU;
		protected $DEF_DOSYA_SORUMLUSU;
		function __construct()
		{
			global $SESSION;
			require_valid_login();
			$this->cdb 				= new db_layer;			
			$this->hasarTable   	= get_hasar_table();									
			$this->companyId 		= OAConf::COMPANY_ID;						
			$this->USER_NAME		= $SESSION['username'];  			
			$this->USER_ID			= $SESSION['user_id'];  						
			$this->kullaniciKontrol();				
						
		}			

		function servisBlok($brans,$tarih1,$tarih2,$marka_id,$kullanim_sekli,$uzman,$servis_tipi,$filo_haric,$filo_acenteler,$faturali_haric,$modul_haric){
            if( ($this->kullaniciKontrol() == '2' || $this->hdsKullaniciKriter) ) { return false;}

            if($brans!=NULL && $brans!=-1){
                $kriter .=  " AND H.SIGORTA_SEKLI='$brans'";
            }

            if(($tarih1 && $tarih2)){
                $kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
            } else {
                $tarih1 = date("Y-m-d", mktime(0, 0, 0, date("01") , date("01"), date("Y")));
                $tarih2 = date("Y-m-d", mktime(0, 0, 0, date("m") , date("d"), date("Y")));
                $kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
            }
			
			if ($filo_haric == 1){
				$acente_arr = explode(",",$filo_acenteler);
				$acente_str = implode("','",$acente_arr);
				$kriter .= " AND H.SB_ACENTE_KODU NOT IN ('".$acente_str."')";
			}

			if($faturali_haric==1){
				$kriter .= " AND H.USER_EKSPER NOT IN ('ALIOZC1','FUTBUL1','SAMBAY1','MURKAY1','YILCAY1','ERSGUL1','EMRTAN1','ARVALFAT','DRD','HEDEF')";
			}

			if($modul_haric == 1){
				$kriter .= " AND U.SERVIS_IDSI<1";
			}			

            if($marka_id!=NULL && $marka_id!='-1'){
                $kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.MARKA_ID , H.HAS_MARKA_ID)='$marka_id'";
            }

            if(($kullanim_sekli!=NULL && $kullanim_sekli!='-1')){
                $kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.SB_ARAC_KULLANIM_TURU , H.SB_ARAC_KULLANIM_TURU)='$kullanim_sekli'";
            }

            if(($uzman!=NULL &&  $uzman!='-1')){
                $kriter .=  " AND HDS.SORUMLU='$uzman'";
            }

            if(($servis_tipi!=NULL &&  $servis_tipi!='-1')){
                $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='$servis_tipi'";
            }

            $sql="SELECT 
                     COUNT(DISTINCT H.ID) AS TOPLAM_DOSYA_KALEM_ADET,
                     SUM(IFNULL(HDO.ILK_TUTAR,0)) ILK_TOPLAM_TUTAR ,
                     SUM(IFNULL(HDO.ONAY_TUTAR,0)) TOPLAM_ONAY_TUTAR 
                     
                    FROM ".$this->hasarTable." H
                        INNER JOIN USERS U ON H.USER_EKSPER = U.U_NAME
                        INNER JOIN HKMEKS_DOSYA_SORUMLULARI HDS ON HDS.DOSYA_ID = H.ID
                        INNER JOIN SERVIS SR ON SR.ID = H.SERVIS_ID 
                        LEFT JOIN HASAR_MAGDUR_ARACLAR HMA ON H.ONAY_NO = HMA.ONAY_NO
                        LEFT JOIN  TMP_".$this->hasarTable."_TOPLAM AS T ON H.ONAY_NO = T.ONAY_NO
                        INNER JOIN  HKMEKS_DOSYA_ONAY HDO ON HDO.DOSYA_ID = H.ID AND HDO.DURUM_ID!=2
                    WHERE 
                        U.ENABLED=1
                        AND U.HKM_EKSPER = 1
                        AND U.FATURALI_KULLANICI = 1
                        AND U.OTOMOTIV!=1
                        AND IFNULL(H.TALEPSIZ,0) <> 1 
					    AND IFNULL(H.PERT, 0) <> 1
                        $kriter
                    ";

            //if(dbg()) { echo($sql); }
            if (!($this->cdb->execute_sql($sql,$result,$error_msg))){return false;}
            $row = mysql_fetch_object($result);
            return $row;
        }

		function markaBlok($brans,$tarih1,$tarih2,$marka_id,$kullanim_sekli,$tedarikci,$filo_haric,$filo_acenteler,$faturali_haric,$modul_haric){			
			
			if( ($this->kullaniciKontrol() == '2' || $this->hdsKullaniciKriter) ) { return false;}
						
			if($brans!=NULL && $brans!=-1){ 
				$kriter .=  " AND H.SIGORTA_SEKLI='$brans'";
			}
						
			if(($tarih1 && $tarih2)){				
				$kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
			} else {					
				$tarih1 = date("Y-m-d", mktime(0, 0, 0, date("01") , date("01"), date("Y")));
				$tarih2 = date("Y-m-d", mktime(0, 0, 0, date("m") , date("d"), date("Y")));	
				$kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
			}

			if ($filo_haric == 1){
				$acente_arr = explode(",",$filo_acenteler);
				$acente_str = implode("','",$acente_arr);
				$kriter .= " AND H.SB_ACENTE_KODU NOT IN ('".$acente_str."')";
			}												
			
			if($faturali_haric==1){
				$kriter .= " AND H.USER_EKSPER NOT IN ('ALIOZC1','FUTBUL1','SAMBAY1','MURKAY1','YILCAY1','ERSGUL1','EMRTAN1','ARVALFAT','DRD','HEDEF')";
			}

			if($modul_haric == 1){
				$kriter .= " AND U.SERVIS_IDSI<1";
			}	
			
			if($marka_id!=NULL && $marka_id!='-1'){ 
				$kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.MARKA_ID , H.HAS_MARKA_ID)='$marka_id'";
			}
			
			if(($kullanim_sekli!=NULL && $kullanim_sekli!='-1')){ 
				$kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.SB_ARAC_KULLANIM_TURU , H.SB_ARAC_KULLANIM_TURU)='$kullanim_sekli'";
			}
			
			if(($tedarikci!=NULL &&  $tedarikci!='-1')){ 
				$kriter .=  " AND S.TEDARIKCI_ID='$tedarikci'";
			}			
			/*
			if($servis_turu==1){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1'";}
			if($servis_turu==2){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0'";}
			if($servis_turu==3){ $kriter .=  " AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==4){ $kriter .=  " AND IFNULL(H.ANLASMALI, 0)='0'";}
			if($servis_turu==5){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1' AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==6){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0' AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==7){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1' AND IFNULL(H.ANLASMALI, 0)='0'";}
			if($servis_turu==8){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0' AND IFNULL(H.ANLASMALI, 0)='0'";}
			*/
						
			$fark_hesapla  = " 	(IF(IFNULL(HD.VERITABANINDA,0) =  1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK,0) +
							IF(IFNULL(HD.VERITABANINDA,0) <> 1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK * IFNULL(HD.KHHH_ISKONTO, 0) / 100)))) ,0)
							) >0 AND (IF(IFNULL(HD.VERITABANINDA,0) =  1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK,0) +
							IF(IFNULL(HD.VERITABANINDA,0) <> 1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK * IFNULL(HD.KHHH_ISKONTO, 0) / 100)))) ,0)
							) >= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100";
						
			$sql = "
				SELECT
					M.MARKA_ADI,			
					SUM(IF(SD. STATUS = 1, SD.ADET, 0)) / (SUM(IF(SD. STATUS = 1, SD.ADET, 0)) + SUM(IF(SD. STATUS = 2, SD.ADET, 0))) *100 AS KARSILAMA_ADET ,				
					/* Toplam */
					COUNT(DISTINCT H.ID) AS TOPLAM_DOSYA_KALEM_ADET,

					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, HD.ADET ) ) AS TOPLAM_PARCA_ADET,
					COUNT( DISTINCT IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ID, NULL ) ) AS TOPLAM_TEKIL_ADET,

					/*SUM(  IF ( HD.VERITABANINDA = 1 AND SD.FIYAT_SISTEM IS NOT NULL , HD.BIRIM_FIYAT_SISTEM * HD.ADET,   HD.BIRIM_FIYAT_GERCEK * HD.ADET ) ) AS TOPLAM_TUTAR, */											
					TRUNCATE(
					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL(HD.SIPARIS_SECENEK, 0) = 1,HD.BIRIM_FIYAT_SISTEM * HD.ADET,0))											
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) )
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) )
					+ SUM( IF ( ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO, 0) = 0 ) OR ( HD.SIPARIS_SECENEK = 1 AND SD. STATUS = 2 ), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )) 
					+ SUM( IF ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO, 0) > 0, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )) 
					+ SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK,0) = 1) OR (IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), IF ( HD.VERITABANINDA = 1, HD.BIRIM_FIYAT_SISTEM, HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 )) ,2)AS TOPLAM_SISTEM_TUTAR,					

					TRUNCATE( 
					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF (( HD.SIPARIS_SECENEK = 2) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( IFNULL(HD.YS_ISKONTO, 0) = 0, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) * HD.ADET, 0 ), 0 ) ) 
					+ SUM( IF ( HD.SIPARIS_SECENEK = 2, IF ( IFNULL(HD.YS_ISKONTO, 0) > 0, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) * HD.ADET, 0 ), 0 ) ) 
					+ SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) * HD.ADET, 0 ) )
					$ans_isk ,2)
					AS TOPLAM_ISKONTO_TUTARI,
																		
					/*tedarik genel*/
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) AS TEDARIK_SISTEM_TUTAR,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS TEDARIK_ISK_TUTAR,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS TEDARIK_ISK_TUTARI,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, 0 ) ),2) AS TEDARIK_DEGISIM_ADET,
					/* Orj. Ted. */
					COUNT( DISTINCT IF  (  IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, H.ID, NULL ) ) AS ORJ_TEDARIK_DOSYA_SAYISI,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL( SD.LO, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ADET,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_SISTEM_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ISK_TUTAR, 
					/*toplam iskonto tutarý toplam olarak hesaplanýyor*/
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ISK_TUTARI,
					/* Eþdeðer */

					COUNT(  DISTINCT  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  H.ID,  NULL  )  ) AS ESDEGER_DOSYA_SAYISI,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.ADET,  0  )  ),2) AS ESDEGER_ADET,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS ESDEGER_SISTEM_TUTAR,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ESDEGER_ISK_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ESDEGER_ISK_TUTARI,
					/* LO */

					COUNT(  DISTINCT  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  H.ID,  NULL  )  ) AS LO_DOSYA_SAYISI,

					TRUNCATE(SUM(    IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.ADET,  0  )  ),2) AS LO_ADET,

					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS LO_SISTEM_TUTAR,

					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2) AS LO_ISK_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2) AS LO_ISK_TUTARI,
															
					/* Servis Org. */
					COUNT( DISTINCT IF(( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI ) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), H.ID, NULL ) ) AS SERVIS_ORG_DOSYA_SAYISI,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.ADET, 0 ) ),2) AS SERVIS_ORG_ADET,

					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) AS SERVIS_ORG_SISTEM_TUTAR,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) -  TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)  AS SERVIS_ORG_ISK_TUTAR,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ORG_ISK_TUTARI,

					/* Servis LO-Eþd. */
					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1)) ) ,  H.ID,  NULL  )  ) AS SERVIS_LOESD_DOSYA_SAYISI,    
					
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))) ,  HD.ADET,  0  )  ),2) AS SERVIS_LOESD_ADET,     

					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_LOESD_SISTEM_TUTAR,     

					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_LOESD_ISK_TUTAR,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_LOESD_ISK_TUTARI,
					
					/* Servis lo. */
					COUNT( DISTINCT IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2  AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) )) ,  H.ID,  NULL  )  ) AS SERVIS_DOSYA_SAYISI_LO,    
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ) ),  HD.ADET,  0  )  ),2) AS SERVIS_ADET_LO,											
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_SISTEM_TUTAR_LO,     

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTARI_LO,

					/* Servis eþd. */

					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0,(HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS SERVIS_DOSYA_SAYISI_ESD,    
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.ADET,  0  )  ),2) AS SERVIS_ADET_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_SISTEM_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTARI_ESD,
					
					/* T. Dýþý */

					COUNT(  DISTINCT  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR ( IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),  HD.ADET,  0  )  ),2) AS TD_ADET,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2) AS TD_ISK_TUTAR,

					TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2) AS TD_ISK_TUTARI,

					/*tedarik dýþý lo*/
											
					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI_LO,    
					
					TRUNCATE(SUM( IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ) ),  HD.ADET,  0  )  ),2) AS TD_ADET_LO,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 )  AND $fark_hesapla, (HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)  AS TD_ISK_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 )  AND $fark_hesapla, (HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTARI_LO,

					/*tedarik dýþý eþd*/

					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0,(HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,30,32),1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI_ESD,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.ADET,  0  )  ),2) AS TD_ADET_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTARI_ESD,
					/* td lo_esd. */
					COUNT(  DISTINCT  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  H.ID,  NULL  )  ) AS TD_YC_DOSYA_SAYISI,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  HD.ADET,  0  )  ),2) AS TD_YC_ADET,

					TRUNCATE(SUM(  IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ) AND IFNULL( HD.SIPARIS_VERMEME_SEBEP_ID, 0 ) IN (3, 4, 30, 31, 32),  IF ( HD.VERITABANINDA = 1, HD.BIRIM_FIYAT_SISTEM, HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ),2) AS TD_YC_SISTEM_TUTAR,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  (    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) - (    IF (  HD.VERITABANINDA = 1,  (  HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK  ) + HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100,  HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100  )  )  ) * HD.ADET,  0  )  ),2) AS TD_YC_ISK_TUTAR,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  (    IF (  HD.VERITABANINDA = 1,  (  HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK  ) + HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100,  HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100  )  ) $ans_isk_detay * HD.ADET,  0  ) ),2) AS TD_YC_ISK_TUTARI
				
				FROM
					HASAR_DETAIL HD
					INNER JOIN ".$this->hasarTable." H ON H.ONAY_NO = HD.ONAY_NO 
					INNER JOIN SERVIS SR ON SR.ID = H.SERVIS_ID 
					LEFT JOIN HASAR_MAGDUR_ARACLAR HMA ON H.ONAY_NO = HMA.ONAY_NO
					LEFT JOIN  TMP_".$this->hasarTable."_TOPLAM AS T ON H.ONAY_NO = T.ONAY_NO
					LEFT JOIN SIPARIS_DETAIL SD ON SD.YEDPAR_ID = HD.ID AND SD.STATUS=1										
					LEFT JOIN SIPARIS S ON S.ID = SD.SIPARIS_ID
					LEFT JOIN HKMEKS_DOSYA_ONAY HDO ON HDO.DOSYA_ID = H.ID	
					LEFT JOIN USERS U ON U.U_NAME = H.USER_EKSPER
					LEFT JOIN YS_LOG L ON HD.ID = L.YEDPAR_ID AND L.ID = (SELECT L2.ID FROM YS_LOG L2 WHERE L2.YEDPAR_ID = L.YEDPAR_ID HAVING MIN(L2.PARCA_FIYATI))
					LEFT JOIN MARKA M ON M.MARKA_KODU = IF(H.SIGORTA_SEKLI=1, HMA.MARKA_ID , H.HAS_MARKA_ID)					
				WHERE 
					1
					$kriter
					AND HD.ISLEM = 1 	
					AND H.DOSYA_STATU =1													
					AND H.SIPARIS_UYGUN = 1 
					AND IF(HD.YS_ISKONTO>0,1,H.ISKONTO_TEDARIKCI>0)
					AND IFNULL(H.TALEPSIZ,0) <> 1 
					AND IFNULL(H.PERT, 0) <> 1
					AND IFNULL(HDO.DURUM_ID,0) <> 2		
				GROUP BY 
					M.MARKA_KODU				
				ORDER BY 
					(TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) 
					-
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) )
					+
					(TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2)
					-
					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) )
					+
					(
					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -
					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) 
					-
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) -  TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) 
					-   
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2)
					-
					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2)
					)					
			";
			//if(dbg()) { echo($sql); } 
			if (!($this->cdb->execute_sql($sql,$result,$error_msg))){return false;}			
			while($row = mysql_fetch_array($result)){			
			$marka_arr[] = $row;
			}
			return $marka_arr;	
		}
		
		function tedarikciBlok($brans,$tarih1,$tarih2,$marka_id,$kullanim_sekli,$tedarikci,$filo_haric,$filo_acenteler,$faturali_haric,$modul_haric){		
			
			if( ($this->kullaniciKontrol() == '2' || $this->hdsKullaniciKriter) ) { return false;}
						
			if($brans!=NULL && $brans!=-1){ 
				$kriter .=  " AND H.SIGORTA_SEKLI='$brans'";
			}
						
			if(($tarih1 && $tarih2)){				
				$kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
			} else {					
				$tarih1 = date("Y-m-d", mktime(0, 0, 0, date("01") , date("01"), date("Y")));
				$tarih2 = date("Y-m-d", mktime(0, 0, 0, date("m") , date("d"), date("Y")));	
				$kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
			}

			if ($filo_haric == 1){
				$acente_arr = explode(",",$filo_acenteler);
				$acente_str = implode("','",$acente_arr);
				$kriter .= " AND H.SB_ACENTE_KODU NOT IN ('".$acente_str."')";
			}

			if($faturali_haric==1){
				$kriter .= " AND H.USER_EKSPER NOT IN ('ALIOZC1','FUTBUL1','SAMBAY1','MURKAY1','YILCAY1','ERSGUL1','EMRTAN1','ARVALFAT','DRD','HEDEF')";
			}

			if($modul_haric == 1){
				$kriter .= " AND U.SERVIS_IDSI<1";
			}		
			
			if($marka_id!=NULL && $marka_id!='-1'){ 
				$kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.MARKA_ID , H.HAS_MARKA_ID)='$marka_id'";
			}
			
			if(($kullanim_sekli!=NULL && $kullanim_sekli!='-1')){ 
				$kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.SB_ARAC_KULLANIM_TURU , H.SB_ARAC_KULLANIM_TURU)='$kullanim_sekli'";
			}
			
			if(($tedarikci!=NULL &&  $tedarikci!='-1')){ 
				$kriter .=  " AND S.TEDARIKCI_ID='$tedarikci'";
			}
			
			/*
			if($servis_turu==1){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1'";}
			if($servis_turu==2){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0'";}
			if($servis_turu==3){ $kriter .=  " AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==4){ $kriter .=  " AND IFNULL(H.ANLASMALI, 0)='0'";}
			if($servis_turu==5){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1' AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==6){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0' AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==7){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1' AND IFNULL(H.ANLASMALI, 0)='0'";}
			if($servis_turu==8){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0' AND IFNULL(H.ANLASMALI, 0)='0'";}
			*/
						
			$fark_hesapla  = " 	(IF(IFNULL(HD.VERITABANINDA,0) =  1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK,0) +
							IF(IFNULL(HD.VERITABANINDA,0) <> 1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK * IFNULL(HD.KHHH_ISKONTO, 0) / 100)))) ,0)
							) >0 AND (IF(IFNULL(HD.VERITABANINDA,0) =  1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK,0) +
							IF(IFNULL(HD.VERITABANINDA,0) <> 1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK * IFNULL(HD.KHHH_ISKONTO, 0) / 100)))) ,0)
							) >= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100";
						
			$sql = "
				SELECT
					LEFT(SU.NAME,25) AS TEDARIKCI,			
					SUM(IF(SD. STATUS = 1, SD.ADET, 0)) / (SUM(IF(SD. STATUS = 1, SD.ADET, 0)) + SUM(IF(SD. STATUS = 2, SD.ADET, 0))) *100 AS KARSILAMA_ADET ,				
					/* Toplam */
					COUNT(DISTINCT H.ID) AS TOPLAM_DOSYA_KALEM_ADET,

					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, HD.ADET ) ) AS TOPLAM_PARCA_ADET,
					COUNT( DISTINCT IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ID, NULL ) ) AS TOPLAM_TEKIL_ADET,

					/*SUM(  IF ( HD.VERITABANINDA = 1 AND SD.FIYAT_SISTEM IS NOT NULL , HD.BIRIM_FIYAT_SISTEM * HD.ADET,   HD.BIRIM_FIYAT_GERCEK * HD.ADET ) ) AS TOPLAM_TUTAR, */											
					TRUNCATE(
					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL(HD.SIPARIS_SECENEK, 0) = 1,HD.BIRIM_FIYAT_SISTEM * HD.ADET,0))											
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) )
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) )
					+ SUM( IF ( ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO, 0) = 0 ) OR ( HD.SIPARIS_SECENEK = 1 AND SD. STATUS = 2 ), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )) 
					+ SUM( IF ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO, 0) > 0, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )) 
					+ SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK,0) = 1) OR (IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), IF ( HD.VERITABANINDA = 1, HD.BIRIM_FIYAT_SISTEM, HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 )) ,2)AS TOPLAM_SISTEM_TUTAR,					

					TRUNCATE( 
					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF (( HD.SIPARIS_SECENEK = 2) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( IFNULL(HD.YS_ISKONTO, 0) = 0, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) * HD.ADET, 0 ), 0 ) ) 
					+ SUM( IF ( HD.SIPARIS_SECENEK = 2, IF ( IFNULL(HD.YS_ISKONTO, 0) > 0, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) * HD.ADET, 0 ), 0 ) ) 
					+ SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) * HD.ADET, 0 ) )
					$ans_isk ,2)
					AS TOPLAM_ISKONTO_TUTARI,
																		
					/*tedarik genel*/
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) AS TEDARIK_SISTEM_TUTAR,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS TEDARIK_ISK_TUTAR,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS TEDARIK_ISK_TUTARI,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, 0 ) ),2) AS TEDARIK_DEGISIM_ADET,
					/* Orj. Ted. */
					COUNT( DISTINCT IF  (  IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, H.ID, NULL ) ) AS ORJ_TEDARIK_DOSYA_SAYISI,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL( SD.LO, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ADET,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_SISTEM_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ISK_TUTAR, 
					/*toplam iskonto tutarý toplam olarak hesaplanýyor*/
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ISK_TUTARI,
					/* Eþdeðer */

					COUNT(  DISTINCT  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  H.ID,  NULL  )  ) AS ESDEGER_DOSYA_SAYISI,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.ADET,  0  )  ),2) AS ESDEGER_ADET,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS ESDEGER_SISTEM_TUTAR,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ESDEGER_ISK_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ESDEGER_ISK_TUTARI,
					/* LO */

					COUNT(  DISTINCT  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  H.ID,  NULL  )  ) AS LO_DOSYA_SAYISI,

					TRUNCATE(SUM(    IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.ADET,  0  )  ),2) AS LO_ADET,

					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS LO_SISTEM_TUTAR,

					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2) AS LO_ISK_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2) AS LO_ISK_TUTARI,
															
					/* Servis Org. */
					COUNT( DISTINCT IF(( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI ) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), H.ID, NULL ) ) AS SERVIS_ORG_DOSYA_SAYISI,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.ADET, 0 ) ),2) AS SERVIS_ORG_ADET,

					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) AS SERVIS_ORG_SISTEM_TUTAR,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) -  TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)  AS SERVIS_ORG_ISK_TUTAR,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ORG_ISK_TUTARI,

					/* Servis LO-Eþd. */
					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1)) ) ,  H.ID,  NULL  )  ) AS SERVIS_LOESD_DOSYA_SAYISI,    
					
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))) ,  HD.ADET,  0  )  ),2) AS SERVIS_LOESD_ADET,     

					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_LOESD_SISTEM_TUTAR,     

					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_LOESD_ISK_TUTAR,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_LOESD_ISK_TUTARI,
					
					/* Servis lo. */
					COUNT( DISTINCT IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2  AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) )) ,  H.ID,  NULL  )  ) AS SERVIS_DOSYA_SAYISI_LO,    
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ) ),  HD.ADET,  0  )  ),2) AS SERVIS_ADET_LO,											
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_SISTEM_TUTAR_LO,     

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTARI_LO,

					/* Servis eþd. */

					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0,(HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS SERVIS_DOSYA_SAYISI_ESD,    
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.ADET,  0  )  ),2) AS SERVIS_ADET_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_SISTEM_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTARI_ESD,
					
					/* T. Dýþý */

					COUNT(  DISTINCT  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR ( IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),  HD.ADET,  0  )  ),2) AS TD_ADET,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2) AS TD_ISK_TUTAR,

					TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2) AS TD_ISK_TUTARI,

					/*tedarik dýþý lo*/
											
					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI_LO,    
					
					TRUNCATE(SUM( IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ) ),  HD.ADET,  0  )  ),2) AS TD_ADET_LO,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 )  AND $fark_hesapla, (HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)  AS TD_ISK_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 )  AND $fark_hesapla, (HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTARI_LO,

					/*tedarik dýþý eþd*/

					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0,(HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,30,32),1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI_ESD,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.ADET,  0  )  ),2) AS TD_ADET_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTARI_ESD,
					/* td lo_esd. */
					COUNT(  DISTINCT  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  H.ID,  NULL  )  ) AS TD_YC_DOSYA_SAYISI,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  HD.ADET,  0  )  ),2) AS TD_YC_ADET,

					TRUNCATE(SUM(  IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ) AND IFNULL( HD.SIPARIS_VERMEME_SEBEP_ID, 0 ) IN (3, 4, 30, 31, 32),  IF ( HD.VERITABANINDA = 1, HD.BIRIM_FIYAT_SISTEM, HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ),2) AS TD_YC_SISTEM_TUTAR,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  (    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) - (    IF (  HD.VERITABANINDA = 1,  (  HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK  ) + HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100,  HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100  )  )  ) * HD.ADET,  0  )  ),2) AS TD_YC_ISK_TUTAR,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  (    IF (  HD.VERITABANINDA = 1,  (  HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK  ) + HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100,  HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100  )  ) $ans_isk_detay * HD.ADET,  0  ) ),2) AS TD_YC_ISK_TUTARI
				
				FROM
					HASAR_DETAIL HD
					INNER JOIN ".$this->hasarTable." H ON H.ONAY_NO = HD.ONAY_NO 
					INNER JOIN SERVIS SR ON SR.ID = H.SERVIS_ID 
					LEFT JOIN HASAR_MAGDUR_ARACLAR HMA ON H.ONAY_NO = HMA.ONAY_NO
					LEFT JOIN  TMP_".$this->hasarTable."_TOPLAM AS T ON H.ONAY_NO = T.ONAY_NO
					INNER JOIN SIPARIS_DETAIL SD ON SD.YEDPAR_ID = HD.ID AND SD.STATUS=1										
					INNER JOIN SIPARIS S ON S.ID = SD.SIPARIS_ID
					LEFT JOIN HKMEKS_DOSYA_ONAY HDO ON HDO.DOSYA_ID = H.ID	
					LEFT JOIN USERS U ON U.U_NAME = H.USER_EKSPER
					LEFT JOIN YS_LOG L ON HD.ID = L.YEDPAR_ID AND L.ID = (SELECT L2.ID FROM YS_LOG L2 WHERE L2.YEDPAR_ID = L.YEDPAR_ID HAVING MIN(L2.PARCA_FIYATI))
					LEFT JOIN SIPARIS_USERS SU ON S.TEDARIKCI_ID = SU.ID
				WHERE 
					1
					$kriter
					AND HD.ISLEM = 1 	
					AND H.DOSYA_STATU =1													
					AND H.SIPARIS_UYGUN = 1 
					AND IF(HD.YS_ISKONTO>0,1,H.ISKONTO_TEDARIKCI>0)
					AND IFNULL(H.TALEPSIZ,0) <> 1 
					AND IFNULL(H.PERT, 0) <> 1
					AND IFNULL(HDO.DURUM_ID,0) <> 2		
				GROUP BY 
					SU.ID				
				ORDER BY 
					(TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) 
					-
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) )
					+
					(TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2)
					-
					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) )
					+
					(
					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -
					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) 
					-
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) -  TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) 
					-   
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2)
					-
					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2)
					)					
			"; 
			//if(dbg()) { echo($sql); } 
			if (!($this->cdb->execute_sql($sql,$result,$error_msg))){return false;}			
			while($row = mysql_fetch_array($result)){			
			$tedarikci_arr[] = $row;
			}
			return $tedarikci_arr;	
		}
		
		function illerBlok($brans,$tarih1,$tarih2,$marka_id,$kullanim_sekli,$tedarikci,$filo_haric,$filo_acenteler,$faturali_haric,$modul_haric){				
			
			if( ($this->kullaniciKontrol() == '2' || $this->hdsKullaniciKriter) ) { return false;}
						
			if($brans!=NULL && $brans!=-1){ 
				$kriter .=  " AND H.SIGORTA_SEKLI='$brans'";
			}
						
			if(($tarih1 && $tarih2)){				
				$kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
			} else {					
				$tarih1 = date("Y-m-d", mktime(0, 0, 0, date("01") , date("01"), date("Y")));
				$tarih2 = date("Y-m-d", mktime(0, 0, 0, date("m") , date("d"), date("Y")));	
				$kriter .=  " AND H.KAYIT_TARIH_SAAT BETWEEN '$tarih1 00:00:00' AND '$tarih2 23:59:59'";
			}	

			if ($filo_haric == 1){
				$acente_arr = explode(",",$filo_acenteler);
				$acente_str = implode("','",$acente_arr);
				$kriter .= " AND H.SB_ACENTE_KODU NOT IN ('".$acente_str."')";
			}	

			if($faturali_haric==1){
				$kriter .= " AND H.USER_EKSPER NOT IN ('ALIOZC1','FUTBUL1','SAMBAY1','MURKAY1','YILCAY1','ERSGUL1','EMRTAN1','ARVALFAT','DRD','HEDEF')";
			}

			if($modul_haric == 1){
				$kriter .= " AND U.SERVIS_IDSI<1";
			}	
			
			if($marka_id!=NULL && $marka_id!='-1'){ 
				$kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.MARKA_ID , H.HAS_MARKA_ID)='$marka_id'";
			}
			
			if(($kullanim_sekli!=NULL && $kullanim_sekli!='-1')){ 
				$kriter .=  " AND IF(H.SIGORTA_SEKLI=1,  HMA.SB_ARAC_KULLANIM_TURU , H.SB_ARAC_KULLANIM_TURU)='$kullanim_sekli'";
			}
			
			if(($tedarikci!=NULL &&  $tedarikci!='-1')){ 
				$kriter .=  " AND S.TEDARIKCI_ID='$tedarikci'";
			}
			
			/*
			if($servis_turu==1){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1'";}
			if($servis_turu==2){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0'";}
			if($servis_turu==3){ $kriter .=  " AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==4){ $kriter .=  " AND IFNULL(H.ANLASMALI, 0)='0'";}
			if($servis_turu==5){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1' AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==6){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0' AND IFNULL(H.ANLASMALI, 0)='1'";}
			if($servis_turu==7){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='1' AND IFNULL(H.ANLASMALI, 0)='0'";}
			if($servis_turu==8){ $kriter .=  " AND IFNULL(H.SERVIS_TUR_ID, 0)='0' AND IFNULL(H.ANLASMALI, 0)='0'";}
			*/
						
			$fark_hesapla  = " 	(IF(IFNULL(HD.VERITABANINDA,0) =  1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK,0) +
							IF(IFNULL(HD.VERITABANINDA,0) <> 1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK * IFNULL(HD.KHHH_ISKONTO, 0) / 100)))) ,0)
							) >0 AND (IF(IFNULL(HD.VERITABANINDA,0) =  1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK,0) +
							IF(IFNULL(HD.VERITABANINDA,0) <> 1 AND HD.ISLEM=1 ,HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK - ((HD.BIRIM_FIYAT_GERCEK * IFNULL(HD.KHHH_ISKONTO, 0) / 100)))) ,0)
							) >= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100";
						
			$sql = "
				SELECT
					IL.ADI AS SERVIS_IL,
					SUM(IF(SD. STATUS = 1, SD.ADET, 0)) / (SUM(IF(SD. STATUS = 1, SD.ADET, 0)) + SUM(IF(SD. STATUS = 2, SD.ADET, 0))) *100 AS KARSILAMA_ADET ,				
					/* Toplam */
					COUNT(DISTINCT H.ID) AS TOPLAM_DOSYA_KALEM_ADET,

					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, HD.ADET ) ) AS TOPLAM_PARCA_ADET,
					COUNT( DISTINCT IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ID, NULL ) ) AS TOPLAM_TEKIL_ADET,

					/*SUM(  IF ( HD.VERITABANINDA = 1 AND SD.FIYAT_SISTEM IS NOT NULL , HD.BIRIM_FIYAT_SISTEM * HD.ADET,   HD.BIRIM_FIYAT_GERCEK * HD.ADET ) ) AS TOPLAM_TUTAR, */											
					TRUNCATE(
					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL(HD.SIPARIS_SECENEK, 0) = 1,HD.BIRIM_FIYAT_SISTEM * HD.ADET,0))											
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) )
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) )
					+ SUM( IF ( ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO, 0) = 0 ) OR ( HD.SIPARIS_SECENEK = 1 AND SD. STATUS = 2 ), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )) 
					+ SUM( IF ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO, 0) > 0, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )) 
					+ SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK,0) = 1) OR (IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), IF ( HD.VERITABANINDA = 1, HD.BIRIM_FIYAT_SISTEM, HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 )) ,2)AS TOPLAM_SISTEM_TUTAR,					

					TRUNCATE( 
					SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ) 
					+ SUM( IF (( HD.SIPARIS_SECENEK = 2) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( IFNULL(HD.YS_ISKONTO, 0) = 0, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) * HD.ADET, 0 ), 0 ) ) 
					+ SUM( IF ( HD.SIPARIS_SECENEK = 2, IF ( IFNULL(HD.YS_ISKONTO, 0) > 0, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) * HD.ADET, 0 ), 0 ) ) 
					+ SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) * HD.ADET, 0 ) )
					$ans_isk ,2)
					AS TOPLAM_ISKONTO_TUTARI,
																		
					/*tedarik genel*/
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) AS TEDARIK_SISTEM_TUTAR,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS TEDARIK_ISK_TUTAR,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS TEDARIK_ISK_TUTARI,
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, 0 ) ),2) AS TEDARIK_DEGISIM_ADET,
					/* Orj. Ted. */
					COUNT( DISTINCT IF  (  IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, H.ID, NULL ) ) AS ORJ_TEDARIK_DOSYA_SAYISI,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL( SD.LO, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ADET,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_SISTEM_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ISK_TUTAR, 
					/*toplam iskonto tutarý toplam olarak hesaplanýyor*/
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ORJ_TEDARIK_ISK_TUTARI,
					/* Eþdeðer */

					COUNT(  DISTINCT  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  H.ID,  NULL  )  ) AS ESDEGER_DOSYA_SAYISI,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.ADET,  0  )  ),2) AS ESDEGER_ADET,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS ESDEGER_SISTEM_TUTAR,

					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ESDEGER_ISK_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) AS ESDEGER_ISK_TUTARI,
					/* LO */

					COUNT(  DISTINCT  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  H.ID,  NULL  )  ) AS LO_DOSYA_SAYISI,

					TRUNCATE(SUM(    IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.ADET,  0  )  ),2) AS LO_ADET,

					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS LO_SISTEM_TUTAR,

					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2) AS LO_ISK_TUTAR,

					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2) AS LO_ISK_TUTARI,
															
					/* Servis Org. */
					COUNT( DISTINCT IF(( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI ) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), H.ID, NULL ) ) AS SERVIS_ORG_DOSYA_SAYISI,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.ADET, 0 ) ),2) AS SERVIS_ORG_ADET,

					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) AS SERVIS_ORG_SISTEM_TUTAR,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) -  TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)  AS SERVIS_ORG_ISK_TUTAR,
					
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ORG_ISK_TUTARI,

					/* Servis LO-Eþd. */
					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1)) ) ,  H.ID,  NULL  )  ) AS SERVIS_LOESD_DOSYA_SAYISI,    
					
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))) ,  HD.ADET,  0  )  ),2) AS SERVIS_LOESD_ADET,     

					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_LOESD_SISTEM_TUTAR,     

					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_LOESD_ISK_TUTAR,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_LOESD_ISK_TUTARI,
					
					/* Servis lo. */
					COUNT( DISTINCT IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2  AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) )) ,  H.ID,  NULL  )  ) AS SERVIS_DOSYA_SAYISI_LO,    
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ) ),  HD.ADET,  0  )  ),2) AS SERVIS_ADET_LO,											
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_SISTEM_TUTAR_LO,     

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, (HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTARI_LO,

					/* Servis eþd. */

					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0,(HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS SERVIS_DOSYA_SAYISI_ESD,    
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.ADET,  0  )  ),2) AS SERVIS_ADET_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS SERVIS_SISTEM_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS SERVIS_ISK_TUTARI_ESD,
					
					/* T. Dýþý */

					COUNT(  DISTINCT  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR ( IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),  HD.ADET,  0  )  ),2) AS TD_ADET,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR,

					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2) AS TD_ISK_TUTAR,

					TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2) AS TD_ISK_TUTARI,

					/*tedarik dýþý lo*/
											
					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI_LO,    
					
					TRUNCATE(SUM( IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0  AND L.LO=1 AND ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ) ),  HD.ADET,  0  )  ),2) AS TD_ADET_LO,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 )  AND $fark_hesapla, (HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)  AS TD_ISK_TUTAR_LO,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, ( HD.SIPARIS_SECENEK NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) <= IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 )  AND $fark_hesapla, (HD.SIPARIS_SECENEK NOT IN (1,2) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID = 30,1 ) AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( L.LO=1 AND  ((HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND HD.KHHH_ISKONTO <= (1- L.PARCA_FIYATI / L.ORJ_FIYAT) * 100), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 )  $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTARI_LO,

					/*tedarik dýþý eþd*/

					COUNT(  DISTINCT  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0,(HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,30,32),1 ) AND $fark_hesapla , ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  H.ID,  NULL  )  ) AS TD_DOSYA_SAYISI_ESD,
					
					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.ADET,  0  )  ),2) AS TD_ADET_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) AS TD_SISTEM_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0   AND ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTAR_ESD,

					TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK  NOT IN (1,2) AND IFNULL(HD.YS_ISKONTO,0)>0 AND IFNULL(HD.YS_ISKONTO,0) > IFNULL(HD.KHHH_ISKONTO,0) ) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 )  AND $fark_hesapla, ( HD.SIPARIS_SECENEK  NOT IN (1,2) AND IF(H.SIPARIS_UYGUN=1, HD.SIPARIS_VERMEME_SEBEP_ID IN (3,4,31,32),1 ) AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 )), IF ( ((L.LO=0 ) OR (L.LO=1 AND (HD.KHHH_ISKONTO > ((1-L.PARCA_FIYATI / L.ORJ_FIYAT) * 100) ))), ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2) AS TD_ISK_TUTARI_ESD,
					/* td lo_esd. */
					COUNT(  DISTINCT  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  H.ID,  NULL  )  ) AS TD_YC_DOSYA_SAYISI,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  HD.ADET,  0  )  ),2) AS TD_YC_ADET,

					TRUNCATE(SUM(  IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ) AND IFNULL( HD.SIPARIS_VERMEME_SEBEP_ID, 0 ) IN (3, 4, 30, 31, 32),  IF ( HD.VERITABANINDA = 1, HD.BIRIM_FIYAT_SISTEM, HD.BIRIM_FIYAT_GERCEK ) * HD.ADET, 0 ) ),2) AS TD_YC_SISTEM_TUTAR,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  (    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) - (    IF (  HD.VERITABANINDA = 1,  (  HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK  ) + HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100,  HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100  )  )  ) * HD.ADET,  0  )  ),2) AS TD_YC_ISK_TUTAR,

					TRUNCATE(SUM(  IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  )  AND IFNULL(  HD.SIPARIS_VERMEME_SEBEP_ID,  0  ) IN (3, 4, 30, 31, 32),  (    IF (  HD.VERITABANINDA = 1,  (  HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK  ) + HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100,  HD.BIRIM_FIYAT_GERCEK * IFNULL(  HD.KHHH_ISKONTO,  0  ) / 100  )  ) $ans_isk_detay * HD.ADET,  0  ) ),2) AS TD_YC_ISK_TUTARI
				
				FROM
					HASAR_DETAIL HD
					INNER JOIN ".$this->hasarTable." H ON H.ONAY_NO = HD.ONAY_NO 
					INNER JOIN SERVIS SR ON SR.ID = H.SERVIS_ID 
					LEFT JOIN HASAR_MAGDUR_ARACLAR HMA ON H.ONAY_NO = HMA.ONAY_NO
					LEFT JOIN  TMP_".$this->hasarTable."_TOPLAM AS T ON H.ONAY_NO = T.ONAY_NO
					LEFT JOIN SIPARIS_DETAIL SD ON SD.YEDPAR_ID = HD.ID AND SD.STATUS=1										
					LEFT JOIN SIPARIS S ON S.ID = SD.SIPARIS_ID
					LEFT JOIN HKMEKS_DOSYA_ONAY HDO ON HDO.DOSYA_ID = H.ID	
					LEFT JOIN USERS U ON U.U_NAME = H.USER_EKSPER
					LEFT JOIN YS_LOG L ON HD.ID = L.YEDPAR_ID AND L.ID = (SELECT L2.ID FROM YS_LOG L2 WHERE L2.YEDPAR_ID = L.YEDPAR_ID HAVING MIN(L2.PARCA_FIYATI))					
					LEFT JOIN ILLER IL ON SR.IL = IL.ID
				WHERE 
					1
					$kriter
					AND HD.ISLEM = 1 	
					AND H.DOSYA_STATU =1													
					AND H.SIPARIS_UYGUN = 1 
					AND IF(HD.YS_ISKONTO>0,1,H.ISKONTO_TEDARIKCI>0)
					AND IFNULL(H.TALEPSIZ,0) <> 1 
					AND IFNULL(H.PERT, 0) <> 1
					AND IFNULL(HDO.DURUM_ID,0) <> 2		
				GROUP BY 					
					IL.ID
				ORDER BY 
					(TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) 
					-
					TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 ) ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) <> 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) )
					+
					(TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2)
					-
					TRUNCATE(SUM( IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 0  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 0 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay) * HD.ADET, 0 ) ),2) )
					+
					(
					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -
					TRUNCATE(SUM(  IF (  IFNULL(SD.ID, 0) > 0  AND IFNULL(  SD.YAN_SANAYI,  0  ) = 1  AND IFNULL(SD.LO, 0) = 1  AND IFNULL(SD. STATUS, 0) = 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1,  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( IFNULL(SD.ID, 0) > 0 AND IFNULL( SD.YAN_SANAYI, 0 ) = 1 AND IFNULL(SD.LO, 0) = 1 AND IFNULL(SD. STATUS, 0) = 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK $ans_isk_detay ) * HD.ADET, 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) 
					-
					TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND  HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), HD.BIRIM_FIYAT_SISTEM * HD.ADET, 0 )),2) -  TRUNCATE(SUM( IF ( ( L.LO IS NULL AND HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)=0) OR ( HD.SIPARIS_SECENEK = 2 AND (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 <= H.ISKONTO_TEDARIKCI) OR (HD.SIPARIS_SECENEK=1 AND SD.STATUS=2), IF ( HD.KHHH_ISKONTO <= H.ISKONTO_TEDARIKCI, ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) 
					-   
					TRUNCATE(SUM(  IF (  IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0) AND $fark_hesapla , ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0 AND L.LO IN (0,1))),  HD.BIRIM_FIYAT_SISTEM * HD.ADET,  0  )  ),2) -  TRUNCATE(SUM(  IF ( IF(IFNULL(L.PARCA_FIYATI,0)=0, (HD.SIPARIS_SECENEK = 2 AND IFNULL(HD.YS_ISKONTO,0)>0 ) AND $fark_hesapla, ( HD.SIPARIS_SECENEK = 2 AND (HD.KHHH_ISKONTO > H.ISKONTO_TEDARIKCI OR (1 - HD.BIRIM_FIYAT_GERCEK / HD.BIRIM_FIYAT_SISTEM ) * 100 > H.ISKONTO_TEDARIKCI) AND L.PARCA_FIYATI > 0)), IF ( L.LO IN (0,1) , ( IF ( HD.VERITABANINDA, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ), 0 ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) $ans_isk_detay * HD.ADET, 0 ), 0 ) ),2)
					)
					+
					(
					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2)
					-
					TRUNCATE(SUM(    IF (  (  IFNULL(  HD.SIPARIS_SECENEK,  0  ) NOT IN (1, 2)  OR (  IFNULL(SD.ID, 0) = 0  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  OR (  IFNULL(SD.ID, 0) > 0  AND IFNULL(SD. STATUS, 0) <> 1  AND IFNULL(  HD.SIPARIS_SECENEK,  0  ) = 1  )  ),    IF (  HD.VERITABANINDA = 1,  HD.BIRIM_FIYAT_SISTEM,  HD.BIRIM_FIYAT_GERCEK  ) * HD.ADET,  0  )  ),2) - TRUNCATE(SUM( IF ( ( IFNULL( HD.SIPARIS_SECENEK, 0 ) NOT IN (1, 2) OR ( IFNULL(SD.ID, 0) = 0 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) OR ( IFNULL(SD.ID, 0) > 0 AND IFNULL(SD. STATUS, 0) <> 1 AND IFNULL( HD.SIPARIS_SECENEK, 0 ) = 1 ) ), ( IF ( HD.VERITABANINDA = 1, ( HD.BIRIM_FIYAT_SISTEM - HD.BIRIM_FIYAT_GERCEK ) + HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100, HD.BIRIM_FIYAT_GERCEK * IFNULL( HD.KHHH_ISKONTO, 0 ) / 100 ) ) $ans_isk_detay * HD.ADET, 0 ) ),2)
					)					
			";
			//if(dbg()) { echo($sql); die;} 
			if (!($this->cdb->execute_sql($sql,$result,$error_msg))){return false;}			
			while($row = mysql_fetch_array($result)){			
			$iller_arr[] = $row;
			}
			return $iller_arr;	
		}		
		
		function modul_aktif_kontrol(){
			
			$modul_eksper				= false;
			$modul_servis				= false;
			$modul_faturali 			= false; 
			$modul_cam 					= false; 
			$modul_tedarik				= false; 
			$modul_mobil				= false; 			
			$modul_otodisi 				= false;
			$modul_arastirmaci 			= false;
			$modul_uzman 				= false;
			$modul_alternatif_tamir 	= false;
			
			//firma id lere göre aktif mi kontrol ediliyor.
			$eksper_aktif_modul_kontrol				= array(18,19,20,23,24,27,28,30,32,37,42,44,47,48,49,50,51,55,56,58,60,64,70,75,80,143,144,145,156,157);
			$servis_aktif_modul_kontrol				= array(18,19,20,27,28,30,37,42,44,47,50,51,55,56,60,64,75,143,144,145,156,157);
			$faturali_aktif_modul_kontrol			= array(18,19,20,24,28,30,32,37,42,44,47,48,49,50,51,55,56,58,60,64,70,75,80,143,144,145,156,157);
			$cam_aktif_modul_kontrol				= array(19,20,24,27,28,30,32,37,42,44,47,48,50,55,56,58,64,75,80,143,144,145,156,157);
			$tedarik_aktif_modul_kontrol			= array(18,19,20,23,24,27,28,30,32,37,42,44,47,48,49,50,51,55,56,58,60,64,70,75,80,143,144,145,156,157);
			$mobil_aktif_modul_kontrol				= array(18,19,20,23,24,27,28,30,32,37,42,44,47,48,49,50,51,55,56,58,60,64,70,75,80,143,144,145,156,157);
			$otodisi_aktif_modul_kontrol 			= array(27,18,30,28,24,51,56,19,23,20,37,32,70,143,55,47,75,58,64);			
			$arastirmaci_aktif_modul_kontrol 		= array(19,20,23,24,28,32,42,44,47,48,51,55,56,58,60,64,80);
			$uzman_aktif_modul_kontrol 				= array(27,49,24,19,23,20,50,37,32,70,55,47,75);
			$alternatif_tamir_aktif_modul_kontrol	= array(20,30,44);
			
			if(in_array($this->companyId,$eksper_aktif_modul_kontrol)) 			{ $modul_eksper = true; }
			if(in_array($this->companyId,$servis_aktif_modul_kontrol)) 			{ $modul_servis = true; }
			if(in_array($this->companyId,$faturali_aktif_modul_kontrol)) 		{ $modul_faturali = true; }			
			if(in_array($this->companyId,$cam_aktif_modul_kontrol)) 			{ $modul_cam = true; }			
			if(in_array($this->companyId,$tedarik_aktif_modul_kontrol)) 		{ $modul_tedarik = true; }			
			if(in_array($this->companyId,$mobil_aktif_modul_kontrol)) 			{ $modul_mobil = true; }			
			if(in_array($this->companyId,$otodisi_aktif_modul_kontrol)) 		{ $modul_otodisi = true; }
			if(in_array($this->companyId,$arastirmaci_aktif_modul_kontrol)) 	{ $modul_arastirmaci = true; }
			if(in_array($this->companyId,$uzman_aktif_modul_kontrol))			{ $modul_uzman = true; }			
			if(in_array($this->companyId,$alternatif_tamir_aktif_modul_kontrol)){ $modul_alternatif_tamir = true; }			
			
			$return_modul = array(
			'modul_eksper'=>$modul_eksper,
			'modul_servis'=>$modul_servis,			
			'modul_faturali'=>$modul_faturali,
			'modul_cam'=>$modul_cam,
			'modul_tedarik'=>$modul_tedarik,
			'modul_mobil'=>$modul_mobil,
			'modul_otodisi'=>$modul_otodisi,
			'modul_arastirmaci'=>$modul_arastirmaci,
			'modul_uzman'=>$modul_uzman,
			'modul_alternatif_tamir'=>$modul_alternatif_tamir,			
			);
			return $return_modul;
			
		}

	}
